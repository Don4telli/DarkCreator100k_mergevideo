<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImageToVideo - Web GUI</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; }
        .container { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 100%; max-width: 800px; }
        h1, h2 { color: #333; text-align: center; margin-bottom: 15px; }
        .tool-buttons { text-align: center; margin-bottom: 30px; }
        .tool-btn { display: inline-block; padding: 8px 16px; margin: 0 5px; background: #f0f0f0; color: #333; text-decoration: none; border-radius: 5px; font-weight: 500; transition: background 0.3s; }
        .tool-btn:hover { background: #e0e0e0; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        input[type="file"], input[type="number"], input[type="text"], select, textarea { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box; font-family: inherit; }
        button { background: #007AFF; color: white; border: none; padding: 12px 24px; border-radius: 5px; font-size: 16px; cursor: pointer; width: 100%; margin-top: 10px; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .progress-container { margin-top: 20px; display: none; text-align: center; }
        .progress-circle { position: relative; width: 80px; height: 80px; border-radius: 50%; background: conic-gradient(#007AFF 0%, #f0f0f0 0%); display: inline-flex; justify-content: center; align-items: center; transition: background 0.3s; }
        .progress-circle::before { content: ''; position: absolute; width: 65px; height: 65px; background: #fff; border-radius: 50%; }
        .progress-text { position: relative; font-size: 16px; font-weight: 600; color: #333; }
        .progress-status-text { margin-top: 15px; color: #666; font-size: 16px; }
        .message-area { margin-top: 20px; text-align: center; }
        .error { color: #FF3B30; background: #FFE5E5; padding: 10px; border-radius: 5px; }
        .success { color: #34C759; background: #E5F7E5; padding: 10px; border-radius: 5px; }
        .download-section { margin-top: 20px; text-align: center; display: none; }
        hr { border: 0; height: 1px; background: #ddd; margin: 40px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¬ DarkNews Creator</h1>
        <div class="tool-buttons">
            <a href="https://chat.openai.com" target="_blank" class="tool-btn">ChatGPT</a>
            <a href="https://fish.audio/pt/" target="_blank" class="tool-btn">Fish Audio</a>
        </div>

        <!-- Coloque isso onde vocÃª quer que o link apareÃ§a -->
        <div style="text-align: center; margin: 20px;">
            <h3>Precisa de um Roteiro para seu VÃ­deo?</h3>
            <p>Use esta ferramenta fantÃ¡stica para gerar um roteiro a partir de um vÃ­deo do TikTok.</p>
            <a href="https://www.script.tokaudit.io/" target="_blank" style="
                display: inline-block;
                padding: 12px 24px;
                background-color: #007AFF; /* Azul bonito */
                color: white;
                text-decoration: none;
                border-radius: 8px;
                font-weight: bold;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            ">
                Abrir Gerador de Roteiro
            </a>
        </div>

        <hr>

        <!-- Create Video Section -->
        <div id="create-video-section">
            <h2>Create Video from Images</h2>
            <form id="createVideoForm">
                <div class="form-group">
                    <label for="images">Select Images:</label>
                    <input type="file" id="images" name="images" multiple required accept="image/*">
                </div>
                <div class="form-group">
                    <label for="audio">Select Audio (optional):</label>
                    <input type="file" id="audio" name="audio" accept="audio/*">
                </div>
                <div class="form-group">
                    <label for="output_name">Output Filename:</label>
                    <input type="text" id="output_name" name="output_name" value="my_video.mp4">
                </div>
                <div class="form-group">
                    <label for="aspect_ratio">Aspect Ratio:</label>
                    <select id="aspect_ratio" name="aspect_ratio">
                        <option value="9:16" selected>9:16 (Portrait)</option>
                        <option value="16:9">16:9 (Landscape)</option>
                        <option value="1:1">1:1 (Square)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="fps">FPS:</label>
                    <input type="number" id="fps" name="fps" value="30" min="1">
                </div>
                <div class="form-group">
                    <label for="green_screen_duration">Green Screen Duration (s):</label>
                    <input type="number" id="green_screen_duration" name="green_screen_duration" value="5.0" step="0.1">
                </div>
                <button type="submit" id="createBtn">Create Video</button>
            </form>
            <div class="progress-container" id="createProgressContainer">
                <div class="progress-circle" id="createProgressCircle">
                    <div class="progress-text" id="createProgressText">0%</div>
                </div>
                <div class="progress-status-text" id="createProgressStatus"></div>
            </div>
            <div class="message-area" id="createMessage"></div>
            <div class="download-section" id="createDownloadSection">
                <button id="createDownloadBtn">Download Video</button>
            </div>
        </div>
    </div>

    <script>
        let progressInterval = null;

        // --- LÃ“GICA DE CRIAÃ‡ÃƒO DE VÃDEO ---
        const createForm = document.getElementById('createVideoForm');
        createForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('createBtn');
            const messageArea = document.getElementById('createMessage');
            const progressContainer = document.getElementById('createProgressContainer');
            const downloadSection = document.getElementById('createDownloadSection');

            btn.disabled = true;
            btn.textContent = 'Processando...';
            messageArea.innerHTML = '';
            progressContainer.style.display = 'block';
            downloadSection.style.display = 'none';

            const formData = new FormData(createForm);
            const imageFiles = document.getElementById('images').files;
            const audioFile = document.getElementById('audio').files[0];

            try {
                const uploadFile = async (file) => {
                    const res = await fetch('/generate_upload_url', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: file.name })
                    });
                    const { upload_url, gcs_path } = await res.json();
                    if (!upload_url) throw new Error('Failed to get upload URL.');

                    await fetch(upload_url, {
                        method: 'PUT',
                        headers: { 'Content-Type': file.type || 'application/octet-stream' },
                        body: file
                    });
                    return gcs_path;
                };

                const imagePaths = [];
                for (const file of imageFiles) {
                    imagePaths.push(await uploadFile(file));
                }

                let audioPath = null;
                if (audioFile) {
                    audioPath = await uploadFile(audioFile);
                }

                const payload = {
                    image_paths: imagePaths,
                    audio_path: audioPath,
                    aspect_ratio: formData.get('aspect_ratio'),
                    fps: formData.get('fps'),
                    green_screen_duration: formData.get('green_screen_duration'),
                    output_name: formData.get('output_name'),
                };

                const response = await fetch('/create_video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || `O servidor respondeu com status ${response.status}`);
                }
                
                startProgressCheck(result.session_id, 'create');

            } catch (err) {
                handleTaskEnd(null, 'create', false, err.message);
            }
        });



        // --- FUNÃ‡Ã•ES COMUNS DE UI ---
        function startProgressCheck(sessionId, type) {
            if (progressInterval) clearInterval(progressInterval);
            progressInterval = setInterval(() => checkProgress(sessionId, type), 2500);
        }

        async function checkProgress(sessionId, type) {
            try {
                const response = await fetch(`/progress?session_id=${sessionId}&type=${type}`);
                if (!response.ok) throw new Error('Falha na resposta do servidor de progresso.');
                
                const data = await response.json();

                const progressCircle = document.getElementById(`${type}ProgressCircle`);
                const progressTextElem = document.getElementById(`${type}ProgressText`);
                const progressStatusText = document.getElementById(`${type}ProgressStatus`);
                
                const progress = Math.round(data.progress || 0);
                progressCircle.style.background = `conic-gradient(#007AFF ${progress * 3.6}deg, #f0f0f0 ${progress * 3.6}deg)`;
                progressTextElem.textContent = `${progress}%`;
                progressStatusText.textContent = data.message;

                if (data.message && (data.message.toLowerCase().includes('erro') || data.message.toLowerCase().includes('falha'))) {
                    handleTaskEnd(sessionId, type, false, data.message, data);
                } else if (progress >= 100) {
                    handleTaskEnd(sessionId, type, true, data.message, data);
                }
            } catch (err) {
                handleTaskEnd(null, type, false, 'Falha ao obter progresso.', {});
            }
        }

        function handleTaskEnd(sessionId, type, success, message, data) {
            clearInterval(progressInterval);
            const messageArea = document.getElementById(`${type}Message`);
            messageArea.innerHTML = `<div class="${success ? 'success' : 'error'}">${message}</div>`;

            if (type === 'create') {
                const createBtn = document.getElementById('createBtn');
                createBtn.disabled = false;
                createBtn.textContent = 'Create Video';
                if (success && data.signed_url) {
                    const downloadSection = document.getElementById('createDownloadSection');
                    downloadSection.innerHTML = `<a href="${data.signed_url}" class="tool-btn" download="${data.output_name || 'video.mp4'}" style="background-color: #34C759; color: white;">Download Video</a>`;
                    downloadSection.style.display = 'block';
                } else if (success && data.local_file) {
                     const downloadSection = document.getElementById('createDownloadSection');
                    downloadSection.innerHTML = `<button onclick="window.location.href='/download/${sessionId}'">Download Local Copy</button>`;
                    downloadSection.style.display = 'block';
                }
            }
        }


    </script>
</body>
</html>